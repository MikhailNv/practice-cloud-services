## Цель работы:
Реализовать приложение в запущенном контейнере, записывающее изменения в базу данных.

## Задачи:
* Написать программу, которая записывает в базу данных переданное в команде запуска значение.
* Реализовать docker-compose файл для сборки всех необходимых для работы проекта компонентов.
* Протестировать работу развернутого проекта.  

## Ход работы

### Реализация Dockerfile для python программы

В данной лабораторной работе мы решили не отходить от концепции Лабораторной №1 и создали [скрипт](./app/app.py) на python , который принимает аргумент из командной строки и записывает его в базу данных. Данный для подключения будут браться из файлика [settings.py](./app/settings.py), где в свою очередь, добавляются константный переменные для подключения к PostgreSql, который берутся из виртаульной среды контейнера с данным скриптом. Переменные окружения задаются в настройке [docker-compose.yml](./docker-compose.yml).

Для корректного запуска контейнера, вынесем его настройку в отдельный Dockerfile [Docker-app](./Docker-app), в котором опишем последовательность действий для запуска скрипта. В нем будет использоваться исходный образ python:3.9-slim, устанавливаться необходимые системные зависимости и зависимости интерпретатора python из созданного [requirements.txt](./requirements.txt).
```
FROM python:3.9-slim

MAINTAINER MikhailNv

LABEL version='1.0'

WORKDIR /home

COPY requirements.txt .
RUN apt-get update && \
    apt-get install -y python3 && \
    useradd -m mikhailnv -p mikhailnv && \
    pip install -r requirements.txt

USER mikhailnv

COPY ./app/app.py ./app/settings.py .

ENTRYPOINT ["python3", "app.py"]
```

### Реализация Dockerfile для PostgreSql

Для корректного запуска контейнера PostgreSql, вынесем его настройку в отдельный Dockerfile [Docker-db](./Docker-db), в котором опишем последовательность конфигураций для базы даннных. Наш выбор пал на образ postgres:16.1, так как ранее мы работали с данной версии бд. Также указали SQL-скрипт, который должен создать необходимую таблицу с определенным полем в базе данных. Его мы положили в специальную директорию, откуда Docker берет sql-скрипты. Остальная конфигурация данного контейнера находится также в [docker-compose.yml](./docker-compose.yml).
```
FROM postgres:16.1

COPY ./db/ /docker-entrypoint-initdb.d/
```

### Реализация docker-compose

После созданных докерфайлов для нашего скрипта и бд, напишем файл [docker-compose.yml](./docker-compose.yml) в котором распишем различные настройки, необходимые для запуска всех контейнеров. Для удобства использования PostgreSql опешем дополнительный, третий, контейнер pgadmin4, где мы сможем наглядно просматривать добавляемые значения python-скриптом в нашу бд. Для сохранения добавленных данных в бд будет использовать volumes - тома (в нашемслучае db_data), с помощью которых можно реализовать хранилище данных внутри контейнера.
```
version: '3'

services:
  app:
    container_name: app
    build:
      context: .
      dockerfile: Docker-app
    environment:
      POSTGRES_DB: site_db
      POSTGRES_USER: mnaumov
      POSTGRES_PASSWORD: mnaumov
      POSTGRES_HOST: site_db
      POSTGRES_PORT: 5432
    depends_on:
      - site_db

  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: mnaumov@boom.com
      PGADMIN_DEFAULT_PASSWORD: mnaumov
    ports:
      - '5050:80'

  site_db:
    container_name: site_db
    build:
      context: .
      dockerfile: Docker-db
    user: root
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=mnaumov
      - POSTGRES_PASSWORD=mnaumov
      - POSTGRES_DB=site_db
    ports:
      - "5432:5432"

volumes:
  db_data:
```

### Сборка

Чтобы наши контейнеры запустились и все необходимые действия выполнились, сначала выполним сборку описанных сущностей в docker-compose файле.

```
docker-compose build
```

![png1](./img/1.png)

### Запуск контейнеров

После прохождения этапа сборки, нам необходимо запустить контейнеры, чтобы все наши службы поднялись, скрипт исполнился и в конечном итоге мы увидели записанные данные в бд.

```
docker-compose up
```

![png2](./img/2.png)

### Перезапуск контейнера app

По заданию нам необходимо реализовать такой функционал у контейнера с приложением, чтобы после каждого перезапуска он вносил новые записи в бд, и все записи при этом сохранялись. При этом, запись должна быть передана в команде запуска контейнера app.

Поэтому чтобы наши новые записи добавились в бд, несколько раз перезапустим app с разными параметрами

![png3](./img/3.png)

### Проверка записей через pgAdmin

Перейдем по адресу http://localhost:5050, по которому открывается UI pgAdmin, введем данные учетной записи, которые мы указывали в [docker-compose.yml](./docker-compose.yml). После подключим нашу бд и выполним простой SQL запрос, чтобы нам вывелись все записи созданной таблицы, куда контейнер app записывал данные.

![png4](./img/4.png)

Как мы видим, значения успешно записались. Таким образом мы успешно выполнили даннуб лабораторную работу.

## Вывод
В ходе выполнения лабораторной работы был создан python-скрипт, который записывает, передающиеся ему через командную строку, параметры в базу данных. Для реализации данного алгоритма был создан файл docker-compose, который собрал в себе все необходимы настройки контейнеров. Во время выполнения работы проблем не возникло.

## Выполнили
Студенты группы К34211: Наумов М., Захаров Е. и Коркунов. Ф